---
title: "Chapter Audit: `r params$lecture`"
author: "`r Sys.info()[['user']]`"
date: '`r format(Sys.time(), format = "%F %T", tz = "Europe/Berlin", usetz = TRUE)`'
output:
  html_document:
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: true
    self_contained: yes
params:
  lecture_dir: !r getwd()
  lecture: !r NULL
  chapters: !r NULL
  pattern: "[.]R$"
  timeout: 300
  run: !r FALSE
  method: "auto"
editor_options:
  chunk_output_type: console
---

```{css, echo=FALSE}
h3 {
  margin-top: 1.25em;
  margin-bottom: 1.25em;
}
.script-success { color: #1B9E77; }
.script-failure { color: #D95F02; }
.audit-warning { color: #D95F02; font-weight: bold; }
.audit-ok { color: #1B9E77; }
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(lese)
library(dplyr)

lecture_dir <- normalizePath(params$lecture_dir, mustWork = TRUE)
lecture <- params$lecture %||% basename(lecture_dir)

# Discover chapters: directories under slides/ that contain figure content
exclude_dirs <- c("attic", "all", "figure", "figure_man", "rsrc", "backup")
slides_dir <- fs::path(lecture_dir, "slides")

if (!fs::dir_exists(slides_dir)) {
  stop(sprintf("Slides directory '%s' not found.", slides_dir))
}

all_chapter_dirs <- fs::dir_ls(slides_dir, type = "directory")
chapter_names <- fs::path_file(all_chapter_dirs)
chapter_names <- setdiff(chapter_names, exclude_dirs)

# Filter to chapters that have figure/, figure_man/, or rsrc/
has_content <- vapply(
  chapter_names,
  function(ch) {
    fs::dir_exists(fs::path(slides_dir, ch, "rsrc")) ||
      fs::dir_exists(fs::path(slides_dir, ch, "figure")) ||
      fs::dir_exists(fs::path(slides_dir, ch, "figure_man"))
  },
  logical(1)
)
chapter_names <- chapter_names[has_content]

# If specific chapters requested, subset
if (!is.null(params$chapters)) {
  missing <- setdiff(params$chapters, chapter_names)
  if (length(missing) > 0) {
    warning(sprintf("Chapters not found: %s", paste(missing, collapse = ", ")))
  }
  chapter_names <- intersect(params$chapters, chapter_names)
}

chapter_names <- sort(chapter_names)
```

```{r run-audits, include=FALSE}
# Run all chapter audits
audit_results <- list()
for (ch in chapter_names) {
  res <- tryCatch(
    audit_chapter(
      ch,
      lecture_dir = lecture_dir,
      pattern = params$pattern,
      timeout = params$timeout,
      run = params$run,
      method = params$method
    ),
    error = function(e) {
      warning(sprintf(
        "audit_chapter failed for '%s': %s",
        ch,
        conditionMessage(e)
      ))
      NULL
    }
  )
  if (!is.null(res)) {
    audit_results[[ch]] <- res
  }
}
# Update chapter_names to only include successful audits
chapter_names <- names(audit_results)
```

This report audits the **figure &harr; slide** dependency chain for
`r lecture`. Each chapter's `figure/` and `figure_man/` directories are
cross-referenced against slide `.tex` files to identify orphaned and missing
figures.

Each lecture chapter may have two figure directories:

- **`figure/`** &mdash; generated figures, typically produced by R scripts in `rsrc/`
- **`figure_man/`** &mdash; manually created or externally sourced figures, not generated by scripts

Both are audited independently.

**Found `r length(chapter_names)` chapter(s)** to audit.

# Overview

```{r overview-table}
safe_nrow <- function(x) if (is.null(x)) 0L else nrow(x)

# Helper to extract a count from each audit result
audit_count <- function(field, fn = length) {
  vapply(audit_results, function(r) fn(r[[field]]), integer(1))
}

overview <- tibble::tibble(
  Chapter = chapter_names,
  Total = audit_count("figures", safe_nrow),
  Orphaned = audit_count("orphaned_figures"),
  Missing = audit_count("missing_figures", safe_nrow),
  Attic = audit_count("attic_figures"),
  Total_ = audit_count("figures_man", safe_nrow),
  Orphaned_ = audit_count("orphaned_figures_man"),
  Missing_ = audit_count("missing_figures_man", safe_nrow),
  `Missing Pkgs` = audit_count("missing_pkgs")
)

# Clean column names for display (remove trailing underscores used for uniqueness)
names(overview) <- sub("_$", "", names(overview))

overview |>
  kableExtra::kbl(caption = "Chapter audit summary") |>
  kableExtra::kable_styling(
    full_width = FALSE,
    bootstrap_options = c("hover", "condensed", "responsive")
  ) |>
  kableExtra::add_header_above(c(
    " " = 1,
    "figure/" = 4,
    "figure_man/" = 3,
    " " = 1
  ))
```

```{r missing-packages-overview, results='asis'}
all_missing_pkgs <- unique(unlist(lapply(
  audit_results,
  function(r) r$missing_pkgs %||% character()
)))

if (length(all_missing_pkgs) > 0) {
  cat("## Missing packages\n\n")
  cat(sprintf(
    "**%d** package(s) used by scripts but not currently installed:\n\n",
    length(all_missing_pkgs)
  ))
  cat(paste0("- `", sort(all_missing_pkgs), "`\n"), sep = "")
  cat("\nInstall all at once:\n\n")
  cat(sprintf(
    "```r\npak::pak(c(%s))\n```\n\n",
    paste0('"', sort(all_missing_pkgs), '"', collapse = ", ")
  ))
}
```

# Chapter Details

```{r chapter-details, results='asis'}
# Helper: build a figure-to-slide reference table
make_fig_table <- function(figures_df, slide_refs, caption) {
  fig_tbl <- tibble::tibble(
    Figure = figures_df$figure_file,
    `Used by slide` = vapply(
      figures_df$figure_base_name,
      function(fig) {
        slides <- names(slide_refs)[vapply(
          slide_refs,
          function(refs) fig %in% refs,
          logical(1)
        )]
        if (length(slides) == 0) "\u274c" else paste(slides, collapse = ", ")
      },
      character(1)
    )
  )
  fig_tbl |>
    kableExtra::kbl(format = "html", escape = FALSE, caption = caption) |>
    kableExtra::kable_styling(
      full_width = TRUE,
      fixed_thead = TRUE,
      bootstrap_options = c("hover", "condensed", "responsive")
    ) |>
    kableExtra::column_spec(1, width = "45%") |>
    kableExtra::column_spec(2, width = "45%")
}

# Helper: build a missing-figures table
make_missing_table <- function(missing_df, subdir) {
  miss_tbl <- missing_df |>
    group_by(figure) |>
    summarize(`Referenced by` = paste(slide, collapse = ", "), .groups = "drop") |>
    rename(Figure = figure)
  miss_tbl |>
    kableExtra::kbl(
      format = "html", escape = FALSE,
      caption = sprintf(
        "%d figure(s) referenced by slides but not in %s/",
        nrow(miss_tbl), subdir
      )
    ) |>
    kableExtra::kable_styling(
      full_width = TRUE,
      bootstrap_options = c("hover", "condensed", "responsive")
    )
}

for (ch in chapter_names) {
  res <- audit_results[[ch]]

  n_figures <- safe_nrow(res$figures)
  n_figures_man <- safe_nrow(res$figures_man)
  n_slides <- length(res$slide_refs)
  cat(sprintf(
    "\n## %s\n\n%d figure/, %d figure_man/, %d slides\n\n",
    ch, n_figures, n_figures_man, n_slides
  ))

  has_issues <- FALSE

  # --- Orphaned figures (figure/) ---
  if (length(res$orphaned_figures) > 0) {
    has_issues <- TRUE
    cat(sprintf(
      "### Orphaned figures (figure/)\n\n**%d** figure(s) on disk but not referenced by any slide:\n\n",
      length(res$orphaned_figures)
    ))
    cat(paste0("- `figure/", res$orphaned_figures, "`\n"), sep = "")
    cat("\n")
  }

  # --- Orphaned figures (figure_man/) ---
  if (length(res$orphaned_figures_man) > 0) {
    has_issues <- TRUE
    cat(sprintf(
      "### Orphaned figures (figure_man/)\n\n**%d** figure(s) on disk but not referenced by any slide:\n\n",
      length(res$orphaned_figures_man)
    ))
    cat(paste0("- `figure_man/", res$orphaned_figures_man, "`\n"), sep = "")
    cat("\n")
  }

  # --- Missing figures (figure/) ---
  if (nrow(res$missing_figures) > 0) {
    has_issues <- TRUE
    cat("### Missing figures (figure/)\n\n")
    cat(make_missing_table(res$missing_figures, "figure"))
    cat("\n\n")
  }

  # --- Missing figures (figure_man/) ---
  if (nrow(res$missing_figures_man) > 0) {
    has_issues <- TRUE
    cat("### Missing figures (figure_man/)\n\n")
    cat(make_missing_table(res$missing_figures_man, "figure_man"))
    cat("\n\n")
  }

  # --- Attic figures ---
  if (length(res$attic_figures) > 0) {
    cat(sprintf(
      "### Attic (figure/)\n\n%d figure(s) parked in `figure/attic/`:\n\n",
      length(res$attic_figures)
    ))
    cat(paste0("- `", res$attic_figures, "`\n"), sep = "")
    cat("\n")
  }
  if (length(res$attic_figures_man) > 0) {
    cat(sprintf(
      "### Attic (figure_man/)\n\n%d figure(s) parked in `figure_man/attic/`:\n\n",
      length(res$attic_figures_man)
    ))
    cat(paste0("- `", res$attic_figures_man, "`\n"), sep = "")
    cat("\n")
  }

  # --- Missing packages ---
  if (length(res$missing_pkgs) > 0) {
    has_issues <- TRUE
    cat("### Missing packages\n\n")
    cat(paste0("- `", res$missing_pkgs, "`\n"), sep = "")
    cat(sprintf(
      "\nInstall from `rsrc/`: `make install-deps`\n\n"
    ))
  }

  # --- Script execution results (only shown when run = TRUE) ---
  n_scripts <- safe_nrow(res$scripts)
  if (params$run && n_scripts > 0) {
    cat("### Script execution\n\n")

    script_tbl <- res$scripts |>
      mutate(
        Status = ifelse(success, "\u2705", "\u274c"),
        Time = sprintf("%.1fs", elapsed),
        Figures = vapply(
          figures_produced,
          function(x) {
            if (length(x) == 0) return("")
            paste(x, collapse = ", ")
          },
          character(1)
        ),
        Note = ifelse(
          success,
          Figures,
          ifelse(
            nchar(error_message) > 100,
            paste0(substr(error_message, 1, 100), "..."),
            error_message
          )
        )
      ) |>
      select(Script = script_file, Status, Time, Note)

    tab <- script_tbl |>
      kableExtra::kbl(
        format = "html", escape = FALSE,
        caption = sprintf("Script execution for %s", ch)
      ) |>
      kableExtra::kable_styling(
        full_width = TRUE, fixed_thead = TRUE,
        bootstrap_options = c("hover", "condensed", "responsive")
      ) |>
      kableExtra::column_spec(1, width = "30%") |>
      kableExtra::column_spec(4, width = "45%")
    cat(tab)
    cat("\n\n")

    n_success <- sum(res$scripts$success)
    n_fail <- sum(!res$scripts$success)
    cat(sprintf("**%d / %d** scripts succeeded", n_success, n_scripts))
    if (n_fail > 0) {
      has_issues <- TRUE
      cat(sprintf(", <span class='script-failure'>%d failed</span>", n_fail))
    }
    cat(".\n\n")

    if (length(res$orphaned_scripts) > 0) {
      cat("### Orphaned scripts\n\n")
      cat(sprintf(
        "**%d** script(s) produced no figure used by any slide:\n\n",
        length(res$orphaned_scripts)
      ))
      cat(paste0("- `", res$orphaned_scripts, "`\n"), sep = "")
      cat("\n")
    }
  }

  if (!has_issues) {
    cat("<span class='audit-ok'>No issues found.</span>\n\n")
  }

  # --- Full figure inventory (collapsed, for reference) ---
  figs_no_attic <- res$figures[!startsWith(res$figures$figure_file, "attic/"), ]
  figs_man_no_attic <- res$figures_man[
    !startsWith(res$figures_man$figure_file, "attic/"),
  ]
  if (nrow(figs_no_attic) > 0 || nrow(figs_man_no_attic) > 0) {
    cat("<details>\n<summary>Full figure inventory</summary>\n\n")
    if (nrow(figs_no_attic) > 0) {
      cat(make_fig_table(
        figs_no_attic, res$slide_refs,
        sprintf("Figures in %s/figure/", ch)
      ))
      cat("\n\n")
    }
    if (nrow(figs_man_no_attic) > 0) {
      cat(make_fig_table(
        figs_man_no_attic, res$slide_refs_man,
        sprintf("Figures in %s/figure_man/", ch)
      ))
      cat("\n\n")
    }
    cat("</details>\n\n")
  }
}
```
